<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç«¶é¦¬ GO / NO-GO åˆ¤å®šï¼ˆãƒ¬ãƒ¼ã‚¹ä¿å­˜ï¼‰</title>

  <!-- PWAï¼ˆmanifest.jsonãŒã‚ã‚‹ãªã‚‰æœ‰åŠ¹ï¼‰ -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background:#f5f5f5; margin:0; padding:12px; }
    h1 { font-size:20px; text-align:center; margin:10px 0 12px; }
    .card { background:#fff; border-radius:14px; padding:12px; margin-bottom:10px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, select, button, textarea { font-size:16px; }
    input, textarea, select { width:100%; box-sizing:border-box; padding:10px; border:1px solid #ddd; border-radius:12px; background:#fff; }
    button { padding:10px 12px; border:none; border-radius:12px; background:#222; color:#fff; font-weight:700; }
    button.secondary { background:#666; }
    button.danger { background:#b00020; }
    button.ghost { background:#fff; color:#222; border:1px solid #ddd; }
    .item { background:#fff; padding:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee; gap:10px; }
    .result { margin-top:10px; padding:12px; border-radius:12px; text-align:center; font-size:18px; font-weight:900; }
    .go { background:#d4edda; color:#155724; }
    .nogo { background:#f8d7da; color:#721c24; }
    .muted { color:#666; font-size:13px; }
    .divider { height:1px; background:#eee; margin:10px 0; }
    .chip { display:inline-block; padding:4px 10px; border-radius:999px; font-size:13px; background:#eee; font-weight:800; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .horseName { font-weight:900; }
    .small { font-size:13px; color:#444; }

    /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    .modalOverlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 9999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }
    .modal h3{ margin: 4px 0 8px; font-size:18px; }
    .modal p{ margin: 0 0 10px; color:#333; line-height:1.4; }
    .modal .modalBtns{ display:flex; flex-direction:column; gap:8px; }
    .modal .modalBtns button{ width:100%; }
    .modal .sub{ font-size:12px; color:#666; margin-top:6px; }
  </style>
</head>

<body>
  <h1>ğŸ‡ GO / NO-GO åˆ¤å®šï¼ˆãƒ¬ãƒ¼ã‚¹ä¿å­˜ï¼‰</h1>

  <!-- ãƒ­ãƒƒã‚¯çŠ¶æ…‹è¡¨ç¤º -->
  <div class="card" id="lockCard" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <div class="chip">ğŸ”’ é–²è¦§ã®ã¿ï¼ˆå…¥åŠ›ãƒ­ãƒƒã‚¯ä¸­ï¼‰</div>
      <button class="ghost" data-allow="true" onclick="showUnlock()">è§£é™¤ã‚­ãƒ¼ã‚’å…¥åŠ›</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      â€» å±¥æ­´ã®é–²è¦§/JSONå‡ºåŠ›ã¯ã§ãã¾ã™ã€‚å…¥åŠ›ã‚’å†é–‹ã™ã‚‹ã«ã¯è§£é™¤ã‚­ãƒ¼ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
    </div>
  </div>

  <!-- ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
  <div class="card">
    <div class="row">
      <div style="flex:2; min-width:160px;">
        <div class="muted">é–‹å‚¬å ´æ‰€ï¼ˆç«¶é¦¬å ´ï¼‰</div>
        <select id="raceCourse">
          <option value="">é¸æŠ</option>
          <option value="æ±äº¬">æ±äº¬</option><option value="ä¸­å±±">ä¸­å±±</option><option value="äº¬éƒ½">äº¬éƒ½</option>
          <option value="é˜ªç¥">é˜ªç¥</option><option value="ä¸­äº¬">ä¸­äº¬</option><option value="æœ­å¹Œ">æœ­å¹Œ</option>
          <option value="å‡½é¤¨">å‡½é¤¨</option><option value="ç¦å³¶">ç¦å³¶</option><option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option>
          <option value="å°å€‰">å°å€‰</option>
        </select>
      </div>

      <div style="flex:1; min-width:120px;">
        <div class="muted">ãƒ¬ãƒ¼ã‚¹</div>
        <select id="raceRound">
          <option value="">R</option>
          <option value="1">1R</option><option value="2">2R</option><option value="3">3R</option><option value="4">4R</option>
          <option value="5">5R</option><option value="6">6R</option><option value="7">7R</option><option value="8">8R</option>
          <option value="9">9R</option><option value="10">10R</option><option value="11">11R</option><option value="12">12R</option>
        </select>
      </div>

      <div style="width:160px;">
        <div class="muted">æ—¥ä»˜</div>
        <input id="raceDate" type="date" />
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div style="flex:1; min-width:150px;">
        <div class="muted">é¦¬ç•ª</div>
        <select id="horseNo">
          <option value="">é¸æŠ</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
          <option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option>
          <option value="17">17</option><option value="18">18</option>
        </select>
      </div>

      <div style="flex:3; min-width:220px;">
        <div class="muted">é¦¬å</div>
        <input id="horseName" placeholder="ä¾‹ï¼šã€‡ã€‡ã€‡ã€‡" />
      </div>

      <div style="min-width:160px;">
        <button onclick="startHorse()">ã“ã®é¦¬ã‚’åˆ¤å®š</button>
      </div>
    </div>

    <div class="muted" style="margin-top:8px;">
      é¦¬ç•ªãƒ»é¦¬å â†’ åˆ¤å®š â†’ 10é …ç›® â†’ ã€Œã“ã®é¦¬ã‚’è¿½åŠ ã€
    </div>
  </div>

  <!-- åˆ¤å®šãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card" id="judgeCard" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <div>
        <span class="chip" id="nowHorseLabel">åˆ¤å®šä¸­</span>
        <div class="muted" id="nowHorseSub"></div>
      </div>
      <div class="row">
        <button class="secondary" onclick="resetForm()">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="ghost" onclick="closeJudge()">é–‰ã˜ã‚‹</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="item">å‰èµ°4è§’5ç•ªæ‰‹ä»¥å†…
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">é€ƒã’ or å…ˆè¡Œå‹
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">åŒè·é›¢ or è·é›¢çŸ­ç¸®
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">ã‚³ãƒ¼ã‚¹å®Ÿç¸¾ã‚ã‚Š
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">é¨æ‰‹ç¶™ç¶š or æ˜ç¢ºå¼·åŒ–
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">é¦¬ä½“é‡ Â±10kgä»¥å†…
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">äººæ°—1ã€œ5ç•ª
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">å˜å‹3ã€œ8å€
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">ä¼‘ã¿æ˜ã‘2èµ°ç›®ä»¥å†…
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>
      <div class="item">å‰ã§é‹ã¹ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
        <select onchange="calc()"><option value="0">Ã—</option><option value="1">â—‹</option></select>
      </div>

      <div id="result" class="result nogo">åˆ¤å®šï¼šNO-GOï¼ˆè¦‹é€ã‚Šï¼‰ 0/10</div>

      <div class="row" style="margin-top:10px;">
        <button onclick="addHorse()">ã“ã®é¦¬ã‚’è¿½åŠ ï¼ˆä¿å­˜å€™è£œã«å…¥ã‚Œã‚‹ï¼‰</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        â—‹7å€‹ä»¥ä¸Š â†’ GOï¼ˆè²·ã†ï¼‰
      </div>
    </div>
  </div>

  <!-- ã“ã®ãƒ¬ãƒ¼ã‚¹ã®ä¸€è¦§ -->
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-end;">
      <div>
        <div style="font-weight:900;">ã“ã®ãƒ¬ãƒ¼ã‚¹ã®åˆ¤å®šä¸€è¦§</div>
        <div class="muted" id="raceSummary">ã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
      </div>
      <div class="row">
        <button class="secondary" onclick="clearRace()">ã“ã®ãƒ¬ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="divider"></div>
    <div class="list" id="horseList"></div>

    <div class="divider"></div>

    <div class="muted">ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒ¬ãƒ¼ã‚¹åˆ¤æ–­ãƒ¡ãƒ¢ï¼‰</div>
    <textarea id="raceMemo" rows="3" placeholder="ä¾‹ï¼šGOãŒ2é ­ãªã‚‰å˜å‹ã€1é ­ãªã‚‰è¦‹é€ã‚Š ãªã©"></textarea>

    <div class="divider"></div>

    <div class="row">
      <div style="flex:1; min-width:160px;">
        <div class="muted">æŠ•è³‡é‡‘é¡ï¼ˆå††ï¼‰</div>
        <input id="stake" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š5000" />
      </div>

      <div style="flex:1; min-width:160px;">
        <div class="muted">æ‰•æˆ»é‡‘ï¼ˆå††ï¼‰</div>
        <input id="payout" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š0ï¼ˆçµæœå¾Œã«å…¥åŠ›ï¼‰" />
      </div>
    </div>

    <div class="result nogo" id="profitBox" style="margin-top:10px;">åæ”¯ï¼š0å††</div>

    <div class="row" style="margin-top:10px;">
      <button onclick="saveRace()">ã“ã®ãƒ¬ãƒ¼ã‚¹ã‚’ä¿å­˜ï¼ˆå±¥æ­´ã¸ï¼‰</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      ä¿å­˜å…ˆï¼šã“ã®iPhoneã®ä¸­ï¼ˆlocalStorageï¼‰
    </div>
  </div>

  <!-- å±¥æ­´ -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:900;">ä¿å­˜ã—ãŸå±¥æ­´</div>
        <div class="muted">éå»ã®ãƒ¬ãƒ¼ã‚¹ã‚’ã„ã¤ã§ã‚‚è¦‹è¿”ã›ã‚‹</div>
      </div>
      <div class="row">
        <button class="secondary" data-allow="true" onclick="exportJSON()">JSONå‡ºåŠ›</button>
        <button class="ghost" data-allow="true" onclick="showUnlock()">è§£é™¤ã‚­ãƒ¼ã‚’å…¥åŠ›</button>
        <button class="danger" data-allow="true" onclick="clearHistory()">å±¥æ­´ã‚’å…¨æ¶ˆã—</button>
      </div>
    </div>
    <div class="divider"></div>
    <div class="list" id="historyList"></div>
  </div>

  <!-- ===== å½¹ã«ç«‹ã£ãŸï¼Ÿï¼ˆ14æ—¥å¾Œï¼‰ ===== -->
  <div class="modalOverlay" id="reviewOverlay">
    <div class="modal">
      <h3>ã“ã®ã‚¢ãƒ—ãƒªã€å½¹ã«ç«‹ã¡ã¾ã—ãŸã‹ï¼Ÿ</h3>
      <p>
        2é€±é–“ä½¿ã£ã¦ã¿ã¦ã©ã†ã§ã—ãŸã‹ï¼Ÿ<br>
        å½¹ã«ç«‹ã£ãŸãªã‚‰ã€è²·ã„åˆ‡ã‚Šã§ã“ã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚
      </p>
      <div class="modalBtns">
        <button onclick="reviewContinue()">å½¹ã«ç«‹ã£ãŸ â†’ ç¶šã‘ãŸã„</button>
        <button class="secondary" onclick="reviewLater()">ã¾ã è¿·ã£ã¦ã„ã‚‹</button>
        <button class="danger" onclick="reviewNoThanks()">ä»Šå›ã¯ä½¿ã‚ãªã„ï¼ˆå…¥åŠ›ãƒ­ãƒƒã‚¯ï¼‰</button>
      </div>
      <div class="sub">â€» å±¥æ­´é–²è¦§/JSONå‡ºåŠ›ã¯ãƒ­ãƒƒã‚¯å¾Œã‚‚ã§ãã¾ã™</div>
    </div>
  </div>

  <!-- ===== è§£é™¤ã‚­ãƒ¼å…¥åŠ› ===== -->
  <div class="modalOverlay" id="unlockOverlay">
    <div class="modal">
      <h3>è§£é™¤ã‚­ãƒ¼ã‚’å…¥åŠ›</h3>
      <p class="muted">è³¼å…¥å¾Œã«å±Šã„ãŸè§£é™¤ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <input id="unlockKeyInput" placeholder="ä¾‹ï¼šUMA-2026-ABCD" />
      <div class="modalBtns" style="margin-top:10px;">
        <button onclick="submitUnlockKey()">è§£é™¤ã™ã‚‹</button>
        <button class="secondary" onclick="hideUnlock()">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sub">â€» ã‚­ãƒ¼ã¯å¤§æ–‡å­—/å°æ–‡å­—ã‚‚åŒºåˆ¥ã—ã¾ã™</div>
    </div>
  </div>

<script>
  // ====== è¨­å®š ======
  const THRESHOLD = 7;
  const FREE_DAYS = 14;
  const PURCHASE_URL = "https://booth.pm/"; // ã‚ã¨ã§è‡ªåˆ†ã®è²©å£²ãƒšãƒ¼ã‚¸ã«å¤‰æ›´

  // è§£é™¤ã‚­ãƒ¼ï¼ˆå£²ã‚ŒãŸã‚‰å¢—ã‚„ã™ï¼‰
  const VALID_UNLOCK_KEYS = ["UMA-2026-ABCD"];

  // storage keys
  const STORAGE_KEY = "keiba_go_nogo_history_v3";
  const INSTALL_KEY = "keiba_installDate_v1";
  const ASKED_KEY   = "keiba_reviewAsked_v1";
  const PAID_KEY    = "keiba_isPaid_v1";
  const LOCK_KEY    = "keiba_inputLocked_v1";

  // çŠ¶æ…‹
  let currentHorse = null;
  let raceHorses = [];

  // åˆæœŸåŒ–
  (function init(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    document.getElementById("raceDate").value = `${yyyy}-${mm}-${dd}`;

    document.getElementById("stake").addEventListener("input", updateProfit);
    document.getElementById("payout").addEventListener("input", updateProfit);
    updateProfit();

    ensureInstallDate();
    renderRaceList();
    renderHistory();
    bootPaywall();
  })();

  // ===== åˆ¤å®šUI =====
  function startHorse(){
    const no = document.getElementById("horseNo").value.trim();
    const name = document.getElementById("horseName").value.trim();
    if(!no || !name){
      alert("é¦¬ç•ªã¨é¦¬åã‚’å…¥ã‚Œã¦ãã ã•ã„");
      return;
    }
    currentHorse = { no, name };
    document.getElementById("nowHorseLabel").textContent = `åˆ¤å®šä¸­ï¼š${no}ç•ª`;
    document.getElementById("nowHorseSub").textContent = name;
    document.getElementById("judgeCard").style.display = "block";
    resetForm();
  }

  function closeJudge(){
    document.getElementById("judgeCard").style.display = "none";
  }

  function resetForm(){
    document.querySelectorAll("#judgeCard select").forEach(s => s.value = "0");
    calc();
  }

  function calc() {
    const selects = document.querySelectorAll("#judgeCard select");
    let score = 0;
    selects.forEach(s => score += Number(s.value));

    const result = document.getElementById("result");
    if (score >= THRESHOLD) {
      result.textContent = `åˆ¤å®šï¼šGOï¼ˆè²·ã†ï¼‰  ${score}/10`;
      result.className = "result go";
    } else {
      result.textContent = `åˆ¤å®šï¼šNO-GOï¼ˆè¦‹é€ã‚Šï¼‰  ${score}/10`;
      result.className = "result nogo";
    }
  }

  function addHorse(){
    if(!currentHorse){
      alert("å…ˆã«ã€Œã“ã®é¦¬ã‚’åˆ¤å®šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„");
      return;
    }
    const answers = Array.from(document.querySelectorAll("#judgeCard select")).map(s=>Number(s.value));
    const score = answers.reduce((a,b)=>a+b,0);
    const judge = score >= THRESHOLD ? "GO" : "NO-GO";

    const item = {
      no: currentHorse.no,
      name: currentHorse.name,
      answers,
      score,
      judge,
      time: new Date().toISOString()
    };

    const idx = raceHorses.findIndex(h => String(h.no) === String(item.no));
    if(idx >= 0) raceHorses[idx] = item; else raceHorses.push(item);

    document.getElementById("horseNo").value = "";
    document.getElementById("horseName").value = "";
    currentHorse = null;
    closeJudge();
    renderRaceList();
  }

  // ===== ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ =====
  function renderRaceList(){
    const list = document.getElementById("horseList");
    list.innerHTML = "";

    if(raceHorses.length === 0){
      document.getElementById("raceSummary").textContent = "ã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“";
      return;
    }

    const sorted = [...raceHorses].sort((a,b)=>Number(a.no)-Number(b.no));
    const goCount = sorted.filter(h=>h.judge==="GO").length;
    const best = sorted.reduce((m,h)=>Math.max(m,h.score),0);

    document.getElementById("raceSummary").textContent =
      `åˆè¨ˆ ${sorted.length}é ­ï¼ˆGO ${goCount}é ­ï¼‰ / æœ€é«˜ã‚¹ã‚³ã‚¢ ${best}/10`;

    sorted.forEach(h=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="flex:1;">
          <div class="horseName">${escapeHtml(h.no)}ç•ª ${escapeHtml(h.name)}</div>
          <div class="small">${h.judge} / ${h.score}/10</div>
        </div>
        <div class="row">
          <button class="secondary" onclick="editHorse('${escapeAttr(h.no)}')">ç·¨é›†</button>
          <button class="danger" onclick="removeHorse('${escapeAttr(h.no)}')">å‰Šé™¤</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function editHorse(no){
    const h = raceHorses.find(x=>String(x.no)===String(no));
    if(!h) return;

    document.getElementById("horseNo").value = h.no;
    document.getElementById("horseName").value = h.name;
    currentHorse = { no: h.no, name: h.name };
    document.getElementById("nowHorseLabel").textContent = `åˆ¤å®šä¸­ï¼š${h.no}ç•ª`;
    document.getElementById("nowHorseSub").textContent = h.name;
    document.getElementById("judgeCard").style.display = "block";

    const selects = document.querySelectorAll("#judgeCard select");
    selects.forEach((s,i)=> s.value = String(h.answers[i] ?? 0));
    calc();
  }

  function removeHorse(no){
    raceHorses = raceHorses.filter(h=>String(h.no)!==String(no));
    renderRaceList();
  }

  function clearRace(){
    if(!confirm("ã“ã®ãƒ¬ãƒ¼ã‚¹ã®å…¥åŠ›ï¼ˆå…¨é ­ï¼‰ã‚’æ¶ˆã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    raceHorses = [];
    document.getElementById("raceMemo").value = "";
    document.getElementById("stake").value = "";
    document.getElementById("payout").value = "";
    updateProfit();
    renderRaceList();
  }

  // ===== åæ”¯ =====
  function updateProfit(){
    const stake = Number(document.getElementById("stake").value) || 0;
    const payout = Number(document.getElementById("payout").value) || 0;
    const profit = payout - stake;

    const box = document.getElementById("profitBox");
    box.textContent = `åæ”¯ï¼š${profit}å††`;
    box.className = "result " + (profit >= 0 ? "go" : "nogo");
  }

  // ===== å±¥æ­´ä¿å­˜ =====
  function loadHistory(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){
      return [];
    }
  }

  function saveHistory(items){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }

  function saveRace(){
    const place = document.getElementById("raceCourse").value;
    const round = document.getElementById("raceRound").value;
    const raceDate = document.getElementById("raceDate").value;

    if(!place || !round){
      alert("é–‹å‚¬å ´æ‰€ã¨ãƒ¬ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„");
      return;
    }
    if(raceHorses.length === 0){
      alert("1é ­ã‚‚è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“");
      return;
    }

    const memo = document.getElementById("raceMemo").value.trim();
    const stake = Number(document.getElementById("stake").value) || 0;
    const payout = Number(document.getElementById("payout").value) || 0;
    const profit = payout - stake;

    const horses = [...raceHorses].sort((a,b)=>Number(a.no)-Number(b.no));
    const goCount = horses.filter(h=>h.judge==="GO").length;

    const race = {
      id: cryptoRandomId(),
      raceName: `${place}${round}`,
      raceDate,
      memo,
      stake,
      payout,
      profit,
      createdAt: new Date().toISOString(),
      summary: { total: horses.length, goCount },
      horses
    };

    const history = loadHistory();
    history.unshift(race);
    saveHistory(history);

    alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
    renderHistory();
  }

  function renderHistory(){
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    const history = loadHistory();

    if(history.length === 0){
      list.innerHTML = `<div class="muted">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    history.forEach(r=>{
      const profitClass = (Number(r.profit)||0) >= 0 ? "go" : "nogo";
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="flex:1;">
          <div class="horseName">${escapeHtml(r.raceName)}</div>
          <div class="small">${escapeHtml(r.raceDate)} / ${r.summary.total}é ­ï¼ˆGO ${r.summary.goCount}é ­ï¼‰</div>
          <div class="small"><span class="${profitClass}" style="padding:2px 8px;border-radius:999px;display:inline-block;">åæ”¯ ${escapeHtml(r.profit ?? 0)}å††</span></div>
          ${r.memo ? `<div class="small">ã‚³ãƒ¡ãƒ³ãƒˆï¼š${escapeHtml(r.memo)}</div>` : ``}
        </div>
        <div class="row">
          <button class="secondary" data-allow="true" onclick="viewRace('${escapeAttr(r.id)}')">è¦‹ã‚‹</button>
          <button class="danger" data-allow="true" onclick="deleteRace('${escapeAttr(r.id)}')">å‰Šé™¤</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function viewRace(id){
    const r = loadHistory().find(x=>x.id===id);
    if(!r) return;
    const lines = [];
    lines.push(`${r.raceName}ï¼ˆ${r.raceDate}ï¼‰`);
    lines.push(`åˆè¨ˆ ${r.summary.total}é ­ / GO ${r.summary.goCount}é ­`);
    lines.push(`æŠ•è³‡ ${r.stake ?? 0}å†† / æ‰•æˆ» ${r.payout ?? 0}å†† / åæ”¯ ${r.profit ?? 0}å††`);
    if(r.memo) lines.push(`ã‚³ãƒ¡ãƒ³ãƒˆï¼š${r.memo}`);
    lines.push("");
    r.horses.forEach(h=> lines.push(`${h.no} ${h.name} : ${h.judge} ${h.score}/10`));
    alert(lines.join("\n"));
  }

  function deleteRace(id){
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    saveHistory(loadHistory().filter(x=>x.id!==id));
    renderHistory();
  }

  function clearHistory(){
    if(!confirm("å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
  }

  function exportJSON(){
    const history = loadHistory();
    const blob = new Blob([JSON.stringify(history, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "keiba-go-nogo-history.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ===== 2é€±é–“å¾Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼†ãƒ­ãƒƒã‚¯ =====
  function ensureInstallDate(){
    if(!localStorage.getItem(INSTALL_KEY)){
      localStorage.setItem(INSTALL_KEY, new Date().toISOString());
    }
  }

  function daysSinceInstall(){
    const raw = localStorage.getItem(INSTALL_KEY);
    if(!raw) return 0;
    const start = new Date(raw).getTime();
    return Math.floor((Date.now() - start) / (1000*60*60*24));
  }

  function shouldShowReview(){
    if(localStorage.getItem(PAID_KEY) === "true") return false;
    if(localStorage.getItem(ASKED_KEY) === "true") return false;
    return daysSinceInstall() >= FREE_DAYS;
  }

  function showReviewPopup(){
    const overlay = document.getElementById("reviewOverlay");
    if(overlay) overlay.style.display = "flex";
  }

  function hideReviewPopup(){
    const overlay = document.getElementById("reviewOverlay");
    if(overlay) overlay.style.display = "none";
  }

  function reviewContinue(){
    localStorage.setItem(ASKED_KEY, "true");
    window.open(PURCHASE_URL, "_blank");
    hideReviewPopup();
    alert("è³¼å…¥å¾Œã«å±Šã„ãŸè§£é™¤ã‚­ãƒ¼ã‚’ã€è§£é™¤ã‚­ãƒ¼ã‚’å…¥åŠ›ã€ã‹ã‚‰å…¥ã‚Œã¦ãã ã•ã„ã€‚");
  }

  function reviewLater(){
    hideReviewPopup();
  }

  function reviewNoThanks(){
    localStorage.setItem(ASKED_KEY, "true");
    localStorage.setItem(LOCK_KEY, "true");
    hideReviewPopup();
    lockInputs();
    renderLockBadge();
  }

  function lockInputs(){
    document.querySelectorAll("input, textarea, select, button").forEach(el=>{
      if(el.dataset && el.dataset.allow === "true") return; // å±¥æ­´ç³»ã¯è¨±å¯
      el.disabled = true;
    });
    try{ closeJudge(); }catch(e){}
  }

  function renderLockBadge(){
    const locked = localStorage.getItem(LOCK_KEY) === "true";
    document.getElementById("lockCard").style.display = locked ? "block" : "none";
  }

  function bootPaywall(){
    renderLockBadge();
    if(localStorage.getItem(LOCK_KEY) === "true"){
      lockInputs();
      return;
    }
    if(shouldShowReview()){
      showReviewPopup();
    }
  }

  // ===== è§£é™¤ã‚­ãƒ¼ =====
  function showUnlock(){
    const overlay = document.getElementById("unlockOverlay");
    if(overlay) overlay.style.display = "flex";
    const input = document.getElementById("unlockKeyInput");
    if(input) input.value = "";
  }

  function hideUnlock(){
    const overlay = document.getElementById("unlockOverlay");
    if(overlay) overlay.style.display = "none";
  }

  function submitUnlockKey(){
    const key = (document.getElementById("unlockKeyInput")?.value || "").trim();
    if(!key){ alert("è§£é™¤ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    if(!VALID_UNLOCK_KEYS.includes(key)){
      alert("ã‚­ãƒ¼ãŒé•ã„ã¾ã™ã€‚è³¼å…¥å¾Œã«å±Šã„ãŸã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
      return;
    }

    localStorage.setItem(PAID_KEY, "true");
    localStorage.removeItem(ASKED_KEY);
    localStorage.removeItem(LOCK_KEY);

    alert("è§£é™¤ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
    hideUnlock();
    location.reload();
  }

  // ===== util =====
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){
    return String(s).replace(/["'\\]/g, m => ({'"':'&quot;',"'":'&#39;',"\\":"\\\\"}[m]));
  }
  function cryptoRandomId(){
    try{
      const b = new Uint8Array(8);
      crypto.getRandomValues(b);
      return Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join('');
    }catch(e){
      return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    }
  }
</script>
</body>
</html>