<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç«¶é¦¬ GO / NO-GO åˆ¤å®š</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background:#f5f5f5; margin:0; padding:12px; }
    h1 { font-size:20px; text-align:center; margin:10px 0 12px; }
    .card { background:#fff; border-radius:10px; padding:12px; margin-bottom:10px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, select, button, textarea { font-size:16px; }
    input, textarea { width:100%; box-sizing:border-box; padding:10px; border:1px solid #ddd; border-radius:10px; }
    button { padding:10px 12px; border:none; border-radius:10px; background:#222; color:#fff; }
    button.secondary { background:#666; }
    button.danger { background:#b00020; }
    .item { background:#fff; padding:10px; margin-bottom:8px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee; }
    .result { margin-top:10px; padding:12px; border-radius:10px; text-align:center; font-size:18px; font-weight:bold; }
    .go { background:#d4edda; color:#155724; }
    .nogo { background:#f8d7da; color:#721c24; }
    .muted { color:#666; font-size:13px; }
    .divider { height:1px; background:#eee; margin:10px 0; }
    .chip { display:inline-block; padding:4px 10px; border-radius:999px; font-size:13px; background:#eee; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .horseLine { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .horseName { font-weight:600; }
    .small { font-size:13px; color:#444; }
  </style>
</head>
<body>
  <h1>ğŸ‡ GO / NO-GO åˆ¤å®šï¼ˆãƒ¬ãƒ¼ã‚¹ä¿å­˜ï¼‰</h1>

  <!-- ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
  <div class="card">
    <div class="row">
      <div style="flex:1; min-width:160px;">
        <div class="muted">ãƒ¬ãƒ¼ã‚¹åï¼ˆä¾‹ï¼šæ±äº¬11R å…±åŒé€šä¿¡æ¯ï¼‰</div>
        <input id="raceName" placeholder="ä¾‹ï¼šæ±äº¬11R å…±åŒé€šä¿¡æ¯" />
      </div>
      <div style="width:160px;">
        <div class="muted">æ—¥ä»˜</div>
        <input id="raceDate" type="date" />
      </div>
    </div>
    <div class="divider"></div>
    <div class="row">
      <div style="flex:1; min-width:160px;">
        <div class="muted">é¦¬ç•ª</div>
        <input id="horseNo" inputmode="numeric" placeholder="ä¾‹ï¼š7" />
      </div>
      <div style="flex:3; min-width:220px;">
        <div class="muted">é¦¬å</div>
        <input id="horseName" placeholder="ä¾‹ï¼šã€‡ã€‡ã€‡ã€‡" />
      </div>
      <div>
        <button onclick="startHorse()">ã“ã®é¦¬ã‚’åˆ¤å®š</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px;">
      ä½¿ã„æ–¹ï¼šé¦¬ç•ªãƒ»é¦¬åã‚’å…¥ã‚Œã¦ã€Œã“ã®é¦¬ã‚’åˆ¤å®šã€â†’10é …ç›®ã‚’é¸ã¶â†’ã€Œã“ã®é¦¬ã‚’è¿½åŠ ã€ã§æ¬¡ã®é¦¬ã¸
    </div>
  </div>

  <!-- åˆ¤å®šãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card" id="judgeCard" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <div>
        <span class="chip" id="nowHorseLabel">åˆ¤å®šä¸­</span>
        <div class="muted" id="nowHorseSub"></div>
      </div>
      <div class="row">
        <button class="secondary" onclick="resetForm()">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="item">å‰èµ°4è§’5ç•ªæ‰‹ä»¥å†…
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">é€ƒã’ or å…ˆè¡Œå‹
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">åŒè·é›¢ or è·é›¢çŸ­ç¸®
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">ã‚³ãƒ¼ã‚¹å®Ÿç¸¾ã‚ã‚Š
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">é¨æ‰‹ç¶™ç¶š or æ˜ç¢ºå¼·åŒ–
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">é¦¬ä½“é‡ Â±10kgä»¥å†…
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">äººæ°—1ã€œ5ç•ª
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">å˜å‹3ã€œ8å€
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">ä¼‘ã¿æ˜ã‘2èµ°ç›®ä»¥å†…
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>
      <div class="item">å‰ã§é‹ã¹ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
        <select onchange="calc()">
          <option value="0">Ã—</option><option value="1">â—‹</option>
        </select>
      </div>

      <div id="result" class="result nogo">åˆ¤å®šï¼šNO-GOï¼ˆè¦‹é€ã‚Šï¼‰ 0/10</div>

      <div class="row" style="margin-top:10px;">
        <button onclick="addHorse()">ã“ã®é¦¬ã‚’è¿½åŠ ï¼ˆä¿å­˜å€™è£œã«å…¥ã‚Œã‚‹ï¼‰</button>
        <button class="secondary" onclick="closeJudge()">åˆ¤å®šã‚’é–‰ã˜ã‚‹</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        â—‹7å€‹ä»¥ä¸Š â†’ å˜å‹å€™è£œï¼ˆã‚ãªãŸã®ãƒ«ãƒ¼ãƒ«ï¼‰ï¼è¿·ã£ãŸã‚‰Ã—
      </div>
    </div>
  </div>

  <!-- ã“ã®ãƒ¬ãƒ¼ã‚¹ã®ä¸€è¦§ -->
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-end;">
      <div>
        <div style="font-weight:700;">ã“ã®ãƒ¬ãƒ¼ã‚¹ã®åˆ¤å®šä¸€è¦§</div>
        <div class="muted" id="raceSummary">ã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
      </div>
      <div class="row">
        <button class="secondary" onclick="clearRace()">ã“ã®ãƒ¬ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="list" id="horseList"></div>

    <div class="divider"></div>

    <div class="muted">ãƒ¬ãƒ¼ã‚¹åˆ¤æ–­ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
    <textarea id="raceMemo" rows="3" placeholder="ä¾‹ï¼šGOãŒ2é ­ãªã‚‰å˜å‹ã€1é ­ãªã‚‰è¦‹é€ã‚Š ãªã©"></textarea>

    <div class="row" style="margin-top:10px;">
      <button onclick="saveRace()">ã“ã®ãƒ¬ãƒ¼ã‚¹ã‚’ä¿å­˜ï¼ˆå±¥æ­´ã¸ï¼‰</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      ä¿å­˜å…ˆï¼šã“ã®iPhoneã®ä¸­ï¼ˆlocalStorageï¼‰ã€‚ãƒãƒƒãƒˆãªã—ã§ã‚‚è¦‹ã‚Œã‚‹ã€‚
    </div>
  </div>

  <!-- å±¥æ­´ -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700;">ä¿å­˜ã—ãŸå±¥æ­´</div>
        <div class="muted">éå»ã®ãƒ¬ãƒ¼ã‚¹ã‚’ã„ã¤ã§ã‚‚è¦‹è¿”ã›ã‚‹</div>
      </div>
      <div class="row">
        <button class="secondary" onclick="exportJSON()">JSONå‡ºåŠ›</button>
        <button class="danger" onclick="clearHistory()">å±¥æ­´ã‚’å…¨æ¶ˆã—</button>
      </div>
    </div>
    <div class="divider"></div>
    <div class="list" id="historyList"></div>
  </div>

<script>
  // ====== è¨­å®š ======
  const THRESHOLD = 7; // 7ä»¥ä¸Šã§GO

  // ====== çŠ¶æ…‹ ======
  let currentHorse = null;     // {no, name}
  let raceHorses = [];         // [{no,name,score,judge,answers:[0/1 x10],time}]
  const STORAGE_KEY = "keiba_go_nogo_history_v1";

  // ====== åˆæœŸåŒ– ======
  (function init(){
    // æ—¥ä»˜ã®åˆæœŸå€¤
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    document.getElementById("raceDate").value = `${yyyy}-${mm}-${dd}`;

    renderRaceList();
    renderHistory();
  })();

  // ====== åˆ¤å®šUI ======
  function startHorse(){
    const no = document.getElementById("horseNo").value.trim();
    const name = document.getElementById("horseName").value.trim();
    if(!no || !name){
      alert("é¦¬ç•ªã¨é¦¬åã‚’å…¥ã‚Œã¦ãã ã•ã„");
      return;
    }
    currentHorse = { no, name };
    document.getElementById("nowHorseLabel").textContent = `åˆ¤å®šä¸­ï¼š${no}ç•ª`;
    document.getElementById("nowHorseSub").textContent = name;
    document.getElementById("judgeCard").style.display = "block";
    resetForm();
  }

  function closeJudge(){
    document.getElementById("judgeCard").style.display = "none";
  }

  function resetForm(){
    document.querySelectorAll("select").forEach(s => s.value = "0");
    calc();
  }

  function calc() {
    const selects = document.querySelectorAll("#judgeCard select");
    let score = 0;
    selects.forEach(s => score += Number(s.value));

    const result = document.getElementById("result");
    if (score >= THRESHOLD) {
      result.textContent = `åˆ¤å®šï¼šGOï¼ˆè²·ã†ï¼‰  ${score}/10`;
      result.className = "result go";
    } else {
      result.textContent = `åˆ¤å®šï¼šNO-GOï¼ˆè¦‹é€ã‚Šï¼‰  ${score}/10`;
      result.className = "result nogo";
    }
  }

  function addHorse(){
    if(!currentHorse){
      alert("å…ˆã«ã€Œã“ã®é¦¬ã‚’åˆ¤å®šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„");
      return;
    }
    const answers = Array.from(document.querySelectorAll("#judgeCard select")).map(s=>Number(s.value));
    const score = answers.reduce((a,b)=>a+b,0);
    const judge = score >= THRESHOLD ? "GO" : "NO-GO";

    // åŒã˜é¦¬ç•ªãŒã‚ã‚Œã°ä¸Šæ›¸ã
    const idx = raceHorses.findIndex(h => String(h.no) === String(currentHorse.no));
    const item = {
      no: currentHorse.no,
      name: currentHorse.name,
      answers,
      score,
      judge,
      time: new Date().toISOString()
    };
    if(idx >= 0) raceHorses[idx] = item; else raceHorses.push(item);

    // æ¬¡ã®é¦¬ã¸
    document.getElementById("horseNo").value = "";
    document.getElementById("horseName").value = "";
    currentHorse = null;
    closeJudge();
    renderRaceList();
  }

  // ====== ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ ======
  function renderRaceList(){
    const list = document.getElementById("horseList");
    list.innerHTML = "";

    if(raceHorses.length === 0){
      document.getElementById("raceSummary").textContent = "ã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“";
      return;
    }

    // è¡¨ç¤ºé †ï¼šé¦¬ç•ªæ˜‡é †
    const sorted = [...raceHorses].sort((a,b)=>Number(a.no)-Number(b.no));
    const goCount = sorted.filter(h=>h.judge==="GO").length;
    const best = sorted.reduce((m,h)=>Math.max(m,h.score),0);

    document.getElementById("raceSummary").textContent =
      `åˆè¨ˆ ${sorted.length}é ­ï¼ˆGO ${goCount}é ­ï¼‰ / æœ€é«˜ã‚¹ã‚³ã‚¢ ${best}/10`;

    sorted.forEach(h=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <div class="horseName">${h.no}ç•ª ${escapeHtml(h.name)}</div>
          <div class="small">${h.judge} / ${h.score}/10</div>
        </div>
        <div class="row">
          <button class="secondary" onclick="editHorse('${h.no}')">ç·¨é›†</button>
          <button class="danger" onclick="removeHorse('${h.no}')">å‰Šé™¤</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function editHorse(no){
    const h = raceHorses.find(x=>String(x.no)===String(no));
    if(!h) return;
    // å…¥åŠ›æ¬„ã«æˆ»ã™
    document.getElementById("horseNo").value = h.no;
    document.getElementById("horseName").value = h.name;
    currentHorse = { no: h.no, name: h.name };
    document.getElementById("nowHorseLabel").textContent = `åˆ¤å®šä¸­ï¼š${h.no}ç•ª`;
    document.getElementById("nowHorseSub").textContent = h.name;
    document.getElementById("judgeCard").style.display = "block";
    // æ—¢å­˜å›ç­”ã‚’å¾©å…ƒ
    const selects = document.querySelectorAll("#judgeCard select");
    selects.forEach((s,i)=> s.value = String(h.answers[i] ?? 0));
    calc();
  }

  function removeHorse(no){
    raceHorses = raceHorses.filter(h=>String(h.no)!==String(no));
    renderRaceList();
  }

  function clearRace(){
    if(!confirm("ã“ã®ãƒ¬ãƒ¼ã‚¹ã®å…¥åŠ›ï¼ˆå…¨é ­ï¼‰ã‚’æ¶ˆã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    raceHorses = [];
    document.getElementById("raceMemo").value = "";
    renderRaceList();
  }

  // ====== å±¥æ­´ä¿å­˜ ======
  function loadHistory(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){
      return [];
    }
  }

  function saveHistory(items){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }

  function saveRace(){
    const raceName = document.getElementById("raceName").value.trim();
    const raceDate = document.getElementById("raceDate").value;
    if(!raceName){
      alert("ãƒ¬ãƒ¼ã‚¹åã‚’å…¥ã‚Œã¦ãã ã•ã„");
      return;
    }
    if(raceHorses.length === 0){
      alert("1é ­ã‚‚è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“");
      return;
    }
    const memo = document.getElementById("raceMemo").value.trim();
    const horses = [...raceHorses].sort((a,b)=>Number(a.no)-Number(b.no));
    const goCount = horses.filter(h=>h.judge==="GO").length;

    const race = {
      id: cryptoRandomId(),
      raceName,
      raceDate,
      memo,
      createdAt: new Date().toISOString(),
      summary: {
        total: horses.length,
        goCount
      },
      horses
    };

    const history = loadHistory();
    history.unshift(race);
    saveHistory(history);

    alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
    renderHistory();
  }

  // ====== å±¥æ­´è¡¨ç¤º ======
  function renderHistory(){
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    const history = loadHistory();

    if(history.length === 0){
      list.innerHTML = `<div class="muted">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    history.forEach(r=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="flex:1;">
          <div class="horseName">${escapeHtml(r.raceName)}</div>
          <div class="small">${r.raceDate} / ${r.summary.total}é ­ï¼ˆGO ${r.summary.goCount}é ­ï¼‰</div>
          ${r.memo ? `<div class="small">ãƒ¡ãƒ¢ï¼š${escapeHtml(r.memo)}</div>` : ``}
        </div>
        <div class="row">
          <button class="secondary" onclick="viewRace('${r.id}')">è¦‹ã‚‹</button>
          <button class="danger" onclick="deleteRace('${r.id}')">å‰Šé™¤</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function viewRace(id){
    const history = loadHistory();
    const r = history.find(x=>x.id===id);
    if(!r) return;

    // ç°¡æ˜“è¡¨ç¤ºï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
    const lines = [];
    lines.push(`${r.raceName}ï¼ˆ${r.raceDate}ï¼‰`);
    lines.push(`åˆè¨ˆ ${r.summary.total}é ­ / GO ${r.summary.goCount}é ­`);
    if(r.memo) lines.push(`ãƒ¡ãƒ¢ï¼š${r.memo}`);
    lines.push("");
    r.horses.forEach(h=>{
      lines.push(`${h.no} ${h.name} : ${h.judge} ${h.score}/10`);
    });
    alert(lines.join("\n"));
  }

  function deleteRace(id){
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    const history = loadHistory().filter(x=>x.id!==id);
    saveHistory(history);
    renderHistory();
  }

  function clearHistory(){
    if(!confirm("å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
  }

  function exportJSON(){
    const history = loadHistory();
    const blob = new Blob([JSON.stringify(history, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "keiba-go-nogo-history.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ====== util ======
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function cryptoRandomId(){
    try{
      const b = new Uint8Array(8);
      crypto.getRandomValues(b);
      return Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join('');
    }catch(e){
      return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    }
  }
</script>
</body>
</html>